import { useState } from "react";
import { useNavigate } from "react-router-dom";
import api from "../../services/api";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { BotForm } from "../../components/Common/BotForm";
import { Form, notification } from "antd";
import axios from "axios";

export default function NewBot() {
  const navigate = useNavigate();
  const [selectedSource, setSelectedSource] = useState<any>({
    id: 1,
    value: "Website",
  });
  const [form] = Form.useForm();
  const client = useQueryClient();
  const onSubmit = async (values: any) => {
    if (selectedSource.id == 2 || selectedSource.id == 5) {
      const formData = new FormData();
      values.file.forEach((file: any) => {
        formData.append("file", file.originFileObj);
      });
      const response = await api.post(
        `/bot/upload?embedding=${values.embedding}&model=${values.model}`,
        formData,
        {
          headers: {
            "Content-Type": "multipart/form-data",
          },
        }
      );
      client.invalidateQueries(["fetchCredits"]);
      return response.data;
    }
    const response = await api.post("/bot", {
      type: selectedSource.value.toLowerCase(),
      ...values,
    });
    client.invalidateQueries(["fetchCredits"]);
    return response.data;
  };
  const { mutateAsync: createBot, isLoading } = useMutation(onSubmit, {
    onSuccess: (data: any) => {
      navigate(`/bot/${data.id}`);
    },
    onError: (e) => {
      console.log(e);
      if (axios.isAxiosError(e)) {
        const message =
          e.response?.data?.message ||
          e?.response?.data?.error ||
          "Something went wrong.";
        notification.error({
          message: "Error",
          description: message,
        });
        return;
      }

      notification.error({
        message: "Error",
        description: "Something went wrong.",
      });
    },
  });

  return (
    <>
      <div className="flex min-h-full flex-col py-12 sm:px-6 lg:px-8 font-work_sans">
        <div className="sm:mx-auto sm:w-full sm:max-w-md flex flex-col gap-[2px] items-center">
          <figure className="bg-[#ecfae5] flex justify-center items-center text-center w-[88px] h-[88px] rounded-full ">
            <svg
              width="60"
              height="60"
              viewBox="0 0 60 60"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M9.48355 24.5421V11.3299C9.48355 11.1797 9.42389 11.0357 9.3177 10.9295C9.21151 10.8233 9.06749 10.7637 8.91731 10.7637C8.76713 10.7637 8.62311 10.8233 8.51692 10.9295C8.41073 11.0357 8.35107 11.1797 8.35107 11.3299V24.5421C8.35107 24.6923 8.41073 24.8363 8.51692 24.9425C8.62311 25.0487 8.76713 25.1083 8.91731 25.1083C9.06749 25.1083 9.21151 25.0487 9.3177 24.9425C9.42389 24.8363 9.48355 24.6923 9.48355 24.5421Z"
                fill="#020617"
              />
              <path
                d="M50.4407 10.7637C50.2906 10.7637 50.1465 10.8233 50.0404 10.9295C49.9342 11.0357 49.8745 11.1797 49.8745 11.3299V24.5421C49.8745 24.6923 49.9342 24.8363 50.0404 24.9425C50.1465 25.0487 50.2906 25.1083 50.4407 25.1083C50.5909 25.1083 50.7349 25.0487 50.8411 24.9425C50.9473 24.8363 51.007 24.6923 51.007 24.5421V11.3299C51.007 11.1797 50.9473 11.0357 50.8411 10.9295C50.7349 10.8233 50.5909 10.7637 50.4407 10.7637Z"
                fill="#020617"
              />
              <path
                d="M29.6862 10.1975C18.6774 10.1975 10.1401 20.4705 10.2386 31.1482L10.2522 35.3271C10.2682 40.2313 12.2276 44.9292 15.7011 48.3914C19.1747 51.8536 23.879 53.7977 28.7832 53.7977H30.5892C35.4934 53.7977 40.1977 51.8536 43.6712 48.3914C47.1448 44.9292 49.1042 40.2313 49.1202 35.3271L49.1338 31.1482C49.2334 20.4705 40.695 10.1975 29.6862 10.1975Z"
                fill="#68BA38"
              />
              <path
                d="M53.0023 30.093C52.9019 27.104 52.8324 25.0406 51.2485 23.4624C49.8102 22.0279 47.8998 21.7671 46.9609 21.7112C48.3898 24.6515 49.1281 27.8794 49.1194 31.1484L49.1058 35.3276C49.102 36.3518 49.0136 37.3738 48.8416 38.3834C49.9399 38.1389 50.941 37.574 51.7181 36.7602C53.1733 35.1751 53.1054 33.1567 53.0023 30.093Z"
                fill="#8CD065"
              />
              <path
                d="M10.2379 35.3274L10.2244 31.1482C10.2157 27.8791 10.954 24.6512 12.3828 21.7109C11.444 21.7668 9.53355 22.0288 8.09531 23.4621C6.50985 25.0404 6.4419 27.1038 6.34149 30.0927C6.23843 33.1565 6.17048 35.1749 7.62722 36.7611C8.40425 37.5748 9.40516 38.1397 10.5033 38.3843C10.3311 37.3744 10.2423 36.3519 10.2379 35.3274Z"
                fill="#8CD065"
              />
              <path
                d="M29.679 49.8339C38.9196 49.8339 45.4959 43.0825 44.5224 33.9793C44.3502 32.3131 43.5679 30.7695 42.3259 29.6456C41.0839 28.5217 39.4701 27.8969 37.7951 27.8915C33.7371 27.9028 33.7371 30.1564 29.679 30.1564C25.621 30.1564 25.621 27.9028 21.563 27.8915C19.888 27.8969 18.2742 28.5217 17.0322 29.6456C15.7902 30.7695 15.0079 32.3131 14.8357 33.9793C13.8622 43.0825 20.4385 49.8339 29.679 49.8339Z"
                fill="#020617"
              />
              <path
                d="M33.1607 39.2993C32.8376 38.9888 32.4062 38.8166 31.9581 38.8191C31.51 38.8217 31.0806 38.9988 30.761 39.3129C30.6344 39.4755 30.4724 39.6072 30.2873 39.6979C30.1022 39.7885 29.8989 39.8358 29.6928 39.836C29.4867 39.8363 29.2832 39.7895 29.0979 39.6993C28.9126 39.6091 28.7502 39.4779 28.6233 39.3155C28.304 39.009 27.8777 38.8391 27.4352 38.8422C26.9926 38.8452 26.5687 39.0208 26.2536 39.3317C25.9386 39.6425 25.7573 40.0641 25.7484 40.5066C25.7395 40.949 25.9036 41.3776 26.2058 41.7009C26.6551 42.1755 27.195 42.5551 27.7936 42.8174C28.3922 43.0797 29.0373 43.2192 29.6908 43.2278C30.3446 43.2195 30.9901 43.08 31.589 42.8178C32.188 42.5555 32.7282 42.1757 33.1777 41.7009C33.491 41.3787 33.6649 40.946 33.6618 40.4966C33.6586 40.0471 33.4786 39.617 33.1607 39.2993Z"
                fill="#DDDDE9"
              />
              <path
                d="M36.0962 32.2214C35.6461 32.2229 35.2149 32.4024 34.8966 32.7206C34.5784 33.0389 34.399 33.4701 34.3975 33.9201V36.5626C34.399 37.0126 34.5784 37.4438 34.8966 37.7621C35.2149 38.0803 35.6461 38.2598 36.0962 38.2613C36.3238 38.2582 36.5486 38.2099 36.7575 38.1194C36.9664 38.0289 37.1553 37.8979 37.3132 37.7339C37.4712 37.5699 37.5951 37.3763 37.6778 37.1642C37.7604 36.952 37.8002 36.7256 37.7949 36.498V33.9847C37.8002 33.7571 37.7604 33.5307 37.6778 33.3185C37.5951 33.1064 37.4712 32.9128 37.3132 32.7488C37.1553 32.5849 36.9664 32.4538 36.7575 32.3633C36.5486 32.2728 36.3238 32.2246 36.0962 32.2214Z"
                fill="#DDDDE9"
              />
              <path
                d="M23.2612 32.2214C23.0335 32.2246 22.8088 32.2728 22.5999 32.3633C22.391 32.4538 22.2021 32.5849 22.0441 32.7488C21.8862 32.9128 21.7623 33.1064 21.6796 33.3185C21.5969 33.5307 21.5571 33.7571 21.5625 33.9847V36.498C21.5571 36.7256 21.5969 36.952 21.6796 37.1642C21.7623 37.3763 21.8862 37.5699 22.0441 37.7339C22.2021 37.8979 22.391 38.0289 22.5999 38.1194C22.8088 38.2099 23.0335 38.2582 23.2612 38.2613C23.7113 38.2598 24.1425 38.0803 24.4607 37.7621C24.779 37.4438 24.9584 37.0126 24.9599 36.5626V33.9201C24.9584 33.4701 24.779 33.0389 24.4607 32.7206C24.1425 32.4024 23.7113 32.2229 23.2612 32.2214Z"
                fill="#DDDDE9"
              />
              <path
                d="M8.91712 12.2737C10.4807 12.2737 11.7483 11.0061 11.7483 9.44251C11.7483 7.87889 10.4807 6.61133 8.91712 6.61133C7.3535 6.61133 6.08594 7.87889 6.08594 9.44251C6.08594 11.0061 7.3535 12.2737 8.91712 12.2737Z"
                fill="#020617"
              />
              <path
                d="M50.4406 12.2737C52.0042 12.2737 53.2717 11.0061 53.2717 9.44251C53.2717 7.87889 52.0042 6.61133 50.4406 6.61133C48.8769 6.61133 47.6094 7.87889 47.6094 9.44251C47.6094 11.0061 48.8769 12.2737 50.4406 12.2737Z"
                fill="#020617"
              />
              <path
                d="M29.6858 10.1975C24.3858 10.1975 19.6623 12.5829 16.1958 16.2442C17.4647 18.5767 19.0461 20.7251 20.8963 22.6298C21.3176 23.0572 21.8198 23.3964 22.3736 23.6275C22.9275 23.8586 23.5218 23.9771 24.122 23.9759H35.236C35.8362 23.9771 36.4305 23.8586 36.9844 23.6275C37.5382 23.3964 38.0404 23.0572 38.4617 22.6298C40.3145 20.7224 41.8976 18.5705 43.1671 16.234C39.7014 12.578 34.9816 10.1975 29.6858 10.1975Z"
                fill="#020617"
              />
              <path
                d="M29.679 20.201C30.9299 20.201 31.9439 19.187 31.9439 17.9361C31.9439 16.6852 30.9299 15.6711 29.679 15.6711C28.4281 15.6711 27.4141 16.6852 27.4141 17.9361C27.4141 19.187 28.4281 20.201 29.679 20.201Z"
                fill="#DDDDE9"
              />
            </svg>
          </figure>
          <h2 className="mt-2 text-center text-xl capitalize font-medium tracking-tight text-secondary-500 dark:text-copy-500">
            Create a new bot
          </h2>
          <p className="text-center text-base font-work_sans font-normal text-secondary-500 dark:text-gray-200">
            Please select a data source below
          </p>
        </div>
        <div className="mt-6 sm:mx-auto sm:w-full sm:max-w-lg">
          {/* #f0f0f0 #eaedf4 */}
          <div className="bg-white pt-6 pb-10 px-8 border border-[#e9efe6] sm:rounded-3xl dark:bg-[#0f141f] dark:border-[#151a25] dark:shadow-[0 1px 4px #080b1136] font-work_sans shadow-[0_1px_2px_0_rgb(228,229,231,0.24)]">
            <BotForm
              showEmbeddingAndModels={true}
              createBot={createBot}
              isLoading={isLoading}
              setSelectedSource={setSelectedSource}
              form={form}
            />
          </div>
        </div>
      </div>
    </>
  );
}
